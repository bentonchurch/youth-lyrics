<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Full Screen Grid Fixed</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
<script type="text/javascript" src="https://www.gstatic.com/cv/js/sender/v1/cast_sender.js?loadCastFramework=1"></script>


<style>
html, body { height: 100%; width: 100%; margin: 0; font-family: sans-serif; }
.main-layout { height: 100vh; width: 100vw; gap: 2px; }

.item-4 { background-color: var(--bs-secondary-bg, #dee2e6); display: flex; align-items: center; justify-content: center; gap: 5px; }
.item-2 { background-color: var(--bs-body-bg); color: var(--bs-body-color); border: 1px solid var(--bs-border-color, #dee2e6); padding: 10px; overflow: auto; }

/* Hide actual radio buttons */
input[type="radio"] { display: none; }
/* Make the label act as a selectable container */
.video-radio-label { display: block; cursor: pointer; border: 2px solid transparent; border-radius: 5px; transition: border 0.2s, box-shadow 0.2s; }
/* Glow effect when selected */
input[type="radio"]:checked + .video-radio-label { border: 2px solid #0d6efd; box-shadow: 0 0 10px #0d6efd; }
</style>
</head>
<body>

<div class="main-layout">
  <div class="item-4">
    <button id="btnCast" style="background: none; border: none;" ><i class="bi bi-cast"></i></button>
  </div>
  <div class="item-2">
    <video id="mainVideo" width="100%" height="100%" autoplay muted playsinline></video>
  </div>


<script src="./js/theme.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
const bc = new BroadcastChannel('canvas-channel');
const sidePanel = document.querySelector('.item-3'); // container for previews
const mainVideo = document.getElementById('mainVideo');

let streamCanvas = document.createElement('canvas');
let ctx = streamCanvas.getContext('2d');
let mediaStream = streamCanvas.captureStream(60); // main video stream
mainVideo.srcObject = mediaStream;

// Store preview videos keyed by tab
let previews = {};

bc.onmessage = event => {
    const bitmap = event.data;

    // Set canvas size if needed
    if (streamCanvas.width !== bitmap.width || streamCanvas.height !== bitmap.height) {
        streamCanvas.width = bitmap.width;
        streamCanvas.height = bitmap.height;
    }

    // Draw the incoming frame
    ctx.clearRect(0,0,streamCanvas.width,streamCanvas.height);
    ctx.drawImage(bitmap, 0, 0);

    // Only create a single preview video if not exists
    if (!previews['canvas-preview']) {
        const vid = document.createElement('video');
        vid.autoplay = true;
        vid.muted = true;
        vid.playsInline = true;
        vid.width = 200; // small preview
        vid.style.cursor = 'pointer';
        vid.style.marginBottom = '5px';
        sidePanel.appendChild(vid);

        // Video gets the same stream
        vid.srcObject = mediaStream;

        // Clicking switches main video
        vid.addEventListener('click', () => {
            mainVideo.srcObject = mediaStream;
        });

        previews['canvas-preview'] = vid;
    }
};

const castButton = document.getElementById('btnCast');
  const video = document.getElementById('mainVideo');

  function isChrome() {
    return /Chrome/.test(navigator.userAgent) && /Google Inc/.test(navigator.vendor);
  }

  function isSafari() {
    return /^((?!chrome|android).)*safari/i.test(navigator.userAgent);
  }

  castButton.addEventListener('click', async () => {
    if (isChrome()) {
      console.log("Detected Chrome. Initializing Cast...");
      if (!window.cast || !window.cast.framework) {
        alert("Cast SDK not loaded yet. Please wait a few seconds and try again.");
        return;
      }

      const context = cast.framework.CastContext.getInstance();
      context.setOptions({
        receiverApplicationId: chrome.cast.media.DEFAULT_MEDIA_RECEIVER_APP_ID,
        autoJoinPolicy: chrome.cast.AutoJoinPolicy.TAB_AND_ORIGIN_SCOPED
      });

      const session = await context.requestSession().catch(err => {
        console.error("Cast session error:", err);
        alert("Could not start casting.");
      });

      if (session) {
        const mediaInfo = new chrome.cast.media.MediaInfo(video.currentSrc, 'video/mp4');
        const request = new chrome.cast.media.LoadRequest(mediaInfo);
        session.loadMedia(request).then(
          () => console.log("Media loaded on Chromecast."),
          err => console.error("Error loading media:", err)
        );
      }

    } else if (isSafari()) {
      console.log("Detected Safari. Using AirPlay...");
      if (typeof video.webkitShowPlaybackTargetPicker === "function") {
        video.webkitShowPlaybackTargetPicker();
      } else {
        alert("AirPlay not supported in this version of Safari.");
      }
    } else {
      alert("Casting not supported in this browser.");
    }
  });

</script>
</body>
</html>
