<!DOCTYPE html>
<html lang="en">
  <head>
    <!-- Meta data -->
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />

    <!-- Title -->
    <title>Import | Benton Youth Lyrics</title>

    <!-- Styles -->
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css"
    />
    <link rel="stylesheet" href="./css/styles.css" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap"
      rel="stylesheet"
    />

    <!-- Scripts -->
    <script src="./js/switchPage.js"></script>
  </head>
  <body>
    <div id="import-group">
      <h1>Import a song</h1>

      <!-- URL input items -->
      <div class="url-input-container d-flex gap-1">
        <!-- URL input textbox-->
        <input
          type="text"
          id="import-url-textbox"
          placeholder="Enter a URL to import"
          spellcheck="false"
          class="form-control"
          oninput="verifyTextbox()"
        />

        <!-- URL input button-->
        <button
          type="button"
          id="load-url-button"
          class="btn btn-primary load-url-button"
          onclick="showLoader(); loadSong();"
        >
          <i class="bi bi-arrow-right"></i>
        </button>
      </div>
      <small id="valid-url-warning" class="invisible">
        Please enter a valid
        <a href="https://www.ultimate-guitar.com/" target="_blank"
          >Ultimate Guitar</a
        >
        url
      </small>
      <div class="w-100 d-flex justify-content-center">
        <div
          id="main-loader"
          class="spinner-border text-primary invisible"
          role="status"
          style="width: 2em; height: 2em; font-size: 2em"
        ></div>
      </div>
    </div>

    <div id="content" class="w-100"></div>

    <script>
      let parse;
      import('./js/lyrics/parse.js').then((test) => {
        parse = test.default;
      });

      let data;

      // Synchronous loading function
      async function loadFile(path) {
        return await (await fetch(`https://corsproxy.io/?url=${path}`)).text();
      }

      function verifyTextbox() {
        let string = document.getElementById('import-url-textbox').value;
        let urlRegex = new RegExp(
          'https:\/\/tabs\.ultimate-guitar\.com\/tab\/.*\/.*[0-9]*'
        );
        let valid = urlRegex.test(string);
        if (!valid) {
          document.getElementById('valid-url-warning').classList.add('visible');
          document
            .getElementById('valid-url-warning')
            .classList.remove('invisible');
        } else {
          document
            .getElementById('valid-url-warning')
            .classList.add('invisible');
          document
            .getElementById('valid-url-warning')
            .classList.remove('visible');
        }
        return valid;
      }

      async function showLoader() {
        document.getElementById('main-loader').classList.add('visible');
        document.getElementById('main-loader').classList.remove('invisible');
        return;
      }

      async function hideLoader() {
        document.getElementById('main-loader').classList.add('invisible');
        document.getElementById('main-loader').classList.remove('visible');
        return;
      }

      async function removeImportGroup() {
        document.getElementById('import-group').classList.add('d-none');
        return;
      }

      async function loadSong() {
        showLoader();

        if (verifyTextbox()) {
          data = parse(
            await loadFile(document.getElementById('import-url-textbox').value)
          );

          for (let i = 0; i < data.separators.length; i++) {
            data.separators[i] = Math.floor(data.separators[i]);
          }
          updateDom();
        }

        hideLoader();
      }

      async function updateDom() {
        let previewHTML = '<section class="card card-body bg-light-subtle">';
        for (let i = 0; i < data.lyrics.length; i++) {
          if (data.separators.includes(i) && i !== 0) {
            previewHTML +=
              '</section><section class="card card-body bg-light-subtle">';
          }
          previewHTML +=
            `<span id="verse-${i}">
              <strong>${data.lyrics[i].chordLyrics.split(' ').join('&nbsp;')}</strong>
              <br>
              ${data.lyrics[i].lyrics.split(' ').join('&nbsp;')}
              <br><hr>
            </span>`;
        }
        previewHTML += '</section>';

        document.getElementById('content').innerHTML =
          `<div class="meta w-100 d-flex flex-row align-items-center justify-content-between px-2">
            <div>
              <h1>${data.meta.name}</h1>
              <p>By ${data.meta.artist}</p>
            </div>
            <div><button type="button" class="btn btn-primary" onclick="addSong();">Import <i class="bi bi-arrow-right"></i></button></div>
          </div>
          <div class="preview">
            ${previewHTML}
          </div>`;

        for (let i = 0; i < data.lyrics.length; i++) {
          document
            .getElementById('verse-' + i)
            .addEventListener('click', () => {
              data.separators.push(i + 1);
              data.separators.sort((a, b) => a - b);
              data.separators = data.separators.filter(function (item, pos) {
                return data.separators.indexOf(item) === pos;
              });
              updateDom();
            });
        }
        removeImportGroup();
      }

      function addSong() {
        if (localStorage['songs'] === undefined) {
          let songs = [data];
          localStorage.setItem('songs', JSON.stringify(songs));
        } else {
          let songs = JSON.parse(localStorage['songs']);
          songs.push(data);
          localStorage.setItem('songs', JSON.stringify(songs));
        }
        setPage('index.html');
      }

      let params = new URLSearchParams(document.location.search);

      if (params.get('url') !== null) {
        document.getElementById('import-url-textbox').value = params.get('url');
        showLoader();
        loadSong();
      }
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"></script>
    <script src="./js/theme.js"></script>
  </body>
</html>
